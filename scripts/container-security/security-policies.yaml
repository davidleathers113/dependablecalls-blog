# Container Security Policies and Compliance Configuration
# =======================================================
# This file defines security policies and compliance requirements for containerized applications.
# It implements industry standards including CIS Docker Benchmark, NIST Cybersecurity Framework,
# and PCI DSS requirements for container security.

metadata:
  name: "DCE Container Security Policies"
  version: "1.0.0"
  description: "Comprehensive security policies for DCE containerized infrastructure"
  created: "2024-01-01T00:00:00Z"
  updated: "2024-01-01T00:00:00Z"
  author: "DCE Security Team"
  
# =============================================================================
# COMPLIANCE FRAMEWORKS
# =============================================================================
compliance_frameworks:
  cis_docker_benchmark:
    enabled: true
    version: "1.4.0"
    level: 2  # Level 1 (Basic) or 2 (Advanced)
    
  nist_cybersecurity_framework:
    enabled: true
    functions: ["identify", "protect", "detect", "respond", "recover"]
    
  pci_dss:
    enabled: false  # Enable if processing payment data
    version: "4.0"
    requirements: ["1", "2", "3", "4", "6", "7", "8", "10", "11", "12"]
    
  iso_27001:
    enabled: true
    controls: ["A.12.6.1", "A.14.2.5", "A.18.1.3"]
    
  soc2:
    enabled: true
    trust_criteria: ["security", "availability", "processing_integrity"]

# =============================================================================
# CONTAINER IMAGE SECURITY POLICIES
# =============================================================================
container_image_policies:
  base_image_requirements:
    # Require specific base images
    allowed_base_images:
      - "node:22-alpine@sha256:*"
      - "nginx:1.26-alpine@sha256:*"
      - "redis:7.4-alpine@sha256:*"
      - "gcr.io/distroless/nodejs22-debian12:nonroot@sha256:*"
    
    # Prohibited base images
    prohibited_base_images:
      - "*:latest"
      - "ubuntu:*"
      - "centos:*"
      - "fedora:*"
    
    # Image signing requirements
    image_signing:
      required: true
      trusted_signers:
        - "DCE Security Team"
        - "docker.io/library"
      
    # Vulnerability scanning
    vulnerability_scanning:
      required: true
      max_critical: 0
      max_high: 5
      max_medium: 20
      scanners: ["trivy", "grype", "snyk"]
      
  dockerfile_policies:
    # User configuration
    user_requirements:
      non_root_required: true
      prohibited_users: ["root", "0"]
      minimum_uid: 1000
      
    # Security instructions
    required_instructions:
      - "USER"
      - "HEALTHCHECK"
      
    prohibited_instructions:
      - "ADD http*"  # Prohibit ADD with URLs
      
    # Build security
    build_args_security:
      prohibit_secrets_in_args: true
      require_secret_mounts: true
      
    # Package management
    package_security:
      update_packages: true
      remove_package_cache: true
      pin_package_versions: true

# =============================================================================
# CONTAINER RUNTIME SECURITY POLICIES
# =============================================================================
container_runtime_policies:
  security_context:
    # Privileged containers
    privileged_containers:
      allowed: false
      exceptions: []  # List container names that can be privileged
      
    # Capabilities
    capabilities:
      default_drop: ["ALL"]
      allowed_add: ["CHOWN", "SETGID", "SETUID", "DAC_OVERRIDE", "FOWNER"]
      prohibited_add: ["SYS_ADMIN", "NET_ADMIN", "SYS_TIME", "SYS_MODULE"]
      
    # User and group settings
    user_settings:
      run_as_non_root: true
      run_as_user: 1000
      run_as_group: 1000
      read_only_root_filesystem: true
      
    # Security options
    security_options:
      no_new_privileges: true
      seccomp_profile: "runtime/default"
      apparmor_profile: "runtime/default"
      selinux_options: "container_runtime_t"
      
  resource_constraints:
    # CPU limits
    cpu_limits:
      required: true
      max_cpu_cores: 2.0
      default_cpu_limit: "1.0"
      
    # Memory limits
    memory_limits:
      required: true
      max_memory: "2Gi"
      default_memory_limit: "512Mi"
      
    # Storage limits
    storage_limits:
      ephemeral_storage: "1Gi"
      
    # Process limits
    process_limits:
      max_pids: 1024
      
  # Health and monitoring
  health_monitoring:
    health_checks:
      required: true
      initial_delay: 30
      period: 30
      timeout: 10
      failure_threshold: 3
      
    logging:
      required: true
      log_driver: "json-file"
      max_size: "10m"
      max_files: 3

# =============================================================================
# NETWORK SECURITY POLICIES
# =============================================================================
network_security_policies:
  network_isolation:
    # Default network usage
    default_network:
      usage_allowed: false
      exceptions: []
      
    # Custom networks
    custom_networks:
      required: true
      network_types: ["bridge", "overlay"]
      prohibited_types: ["host", "none"]
      
    # Network segmentation
    segmentation:
      database_isolation: true  # Separate network for databases
      web_tier_isolation: true  # Separate network for web services
      inter_container_communication: false  # Disable by default
      
  port_exposure:
    # Allowed ports
    allowed_ports:
      web: [80, 443, 8080]
      development: [3000, 4173, 5173]
      database: [6379]  # Redis only, no direct DB exposure
      
    # Prohibited ports
    prohibited_ports: [22, 23, 135, 139, 445, 1433, 3306, 3389, 5432, 11211, 27017]
    
    # Port binding
    bind_restrictions:
      all_interfaces: false  # Don't bind to 0.0.0.0
      localhost_only: true   # Prefer 127.0.0.1
      
  dns_security:
    # DNS servers
    allowed_dns_servers:
      - "127.0.0.11"  # Docker embedded DNS
      - "1.1.1.1"     # Cloudflare (if needed)
      - "8.8.8.8"     # Google (if needed)
      
    # DNS search domains
    search_domain_restrictions:
      max_domains: 3
      prohibited_domains: ["com", "net", "org", "local"]

# =============================================================================
# VOLUME AND STORAGE SECURITY POLICIES
# =============================================================================
storage_security_policies:
  volume_mounts:
    # Host path restrictions
    host_path_mounts:
      allowed: true
      prohibited_paths:
        - "/etc"
        - "/proc"
        - "/sys"
        - "/boot"
        - "/dev"
        - "/var/run/docker.sock"
        
    # Read-only mounts
    read_only_enforcement:
      config_files: true
      application_code: true
      certificates: true
      
    # Sensitive file handling
    sensitive_files:
      encryption_required: true
      access_logging: true
      
  data_protection:
    # Encryption at rest
    encryption_at_rest:
      required: true
      algorithms: ["AES-256", "ChaCha20-Poly1305"]
      
    # Backup security
    backup_policies:
      encryption_required: true
      retention_period: 30  # days
      access_logging: true

# =============================================================================
# SECRETS MANAGEMENT POLICIES
# =============================================================================
secrets_management_policies:
  secret_storage:
    # Prohibited storage methods
    prohibited_locations:
      - "environment_variables"
      - "dockerfile"
      - "docker-compose"
      - "source_code"
      
    # Required storage methods
    required_methods:
      - "docker_secrets"
      - "kubernetes_secrets"
      - "external_secret_manager"
      
  secret_lifecycle:
    # Rotation requirements
    rotation:
      required: true
      max_age_days: 90
      automatic_rotation: true
      
    # Access control
    access_control:
      principle_of_least_privilege: true
      access_logging: true
      multi_factor_auth: true
      
  secret_types:
    # Database credentials
    database_credentials:
      complexity_requirements: true
      encryption_in_transit: true
      connection_pooling: true
      
    # API keys
    api_keys:
      scope_limitation: true
      expiration_required: true
      
    # TLS certificates
    tls_certificates:
      minimum_key_size: 2048
      certificate_transparency: true
      ocsp_stapling: true

# =============================================================================
# MONITORING AND COMPLIANCE POLICIES
# =============================================================================
monitoring_compliance_policies:
  security_monitoring:
    # Log aggregation
    log_aggregation:
      required: true
      centralized_logging: true
      log_retention: 365  # days
      
    # Security events
    security_events:
      real_time_alerting: true
      incident_response: true
      forensic_analysis: true
      
    # Metrics collection
    metrics:
      resource_usage: true
      security_events: true
      compliance_status: true
      
  audit_requirements:
    # Audit logging
    audit_logging:
      required: true
      immutable_logs: true
      integrity_verification: true
      
    # Compliance reporting
    compliance_reporting:
      automated_reports: true
      report_frequency: "monthly"
      stakeholder_distribution: true
      
    # Vulnerability management
    vulnerability_management:
      continuous_scanning: true
      automated_patching: true
      exception_tracking: true

# =============================================================================
# INCIDENT RESPONSE POLICIES
# =============================================================================
incident_response_policies:
  detection:
    # Automated detection
    automated_detection:
      anomaly_detection: true
      signature_based: true
      behavioral_analysis: true
      
    # Alert thresholds
    alert_thresholds:
      critical_severity: 0    # Alert immediately
      high_severity: 5        # Alert within 5 minutes
      medium_severity: 30     # Alert within 30 minutes
      
  response:
    # Response times
    response_times:
      critical: 15   # minutes
      high: 60       # minutes
      medium: 240    # minutes
      
    # Escalation procedures
    escalation:
      automatic_escalation: true
      escalation_levels: 3
      
    # Containment measures
    containment:
      automatic_isolation: true
      traffic_blocking: true
      container_quarantine: true
      
  recovery:
    # Backup and restore
    backup_restore:
      automated_backups: true
      tested_restore_procedures: true
      recovery_time_objective: 60  # minutes
      
    # Business continuity
    business_continuity:
      failover_procedures: true
      communication_plan: true
      lessons_learned: true

# =============================================================================
# POLICY ENFORCEMENT SETTINGS
# =============================================================================
policy_enforcement:
  enforcement_mode:
    mode: "enforcing"  # enforcing, permissive, disabled
    
  violation_handling:
    # Action on policy violation
    violation_actions:
      critical: "block"     # block, warn, log
      high: "warn"
      medium: "log"
      low: "log"
      
    # Notification settings
    notifications:
      immediate_alerts: ["critical", "high"]
      daily_summaries: ["medium", "low"]
      
  exemptions:
    # Temporary exemptions
    temporary_exemptions:
      max_duration: 30  # days
      approval_required: true
      
    # Permanent exemptions
    permanent_exemptions:
      security_review_required: true
      documentation_required: true
      periodic_review: 90  # days

# =============================================================================
# POLICY VALIDATION AND TESTING
# =============================================================================
policy_validation:
  validation_frequency:
    policy_review: "quarterly"
    effectiveness_testing: "monthly"
    compliance_audit: "annually"
    
  testing_procedures:
    # Security testing
    security_testing:
      penetration_testing: true
      vulnerability_assessment: true
      red_team_exercises: true
      
    # Compliance testing
    compliance_testing:
      policy_compliance: true
      control_effectiveness: true
      gap_analysis: true
      
  continuous_improvement:
    # Feedback mechanisms
    feedback:
      security_team_input: true
      development_team_feedback: true
      external_audit_findings: true
      
    # Policy updates
    policy_updates:
      threat_landscape_changes: true
      regulatory_updates: true
      technology_evolution: true